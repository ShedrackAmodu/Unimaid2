{% extends 'base.html' %}
{% load static %}

{% block title %}{{ document.title }} - Ramat Library Repository{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/">Home</a></li>
<li class="breadcrumb-item"><a href="{% url 'repository:document_list' %}">Repository</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ document.title|truncatechars:50 }}</li>
{% endblock %}

{% block content %}
<div class="row mb-5">
    <div class="col-lg-8">
        <div class="d-flex align-items-center mb-4">
            <div class="me-3">
                <div style="width: 70px; height: 70px; background: var(--gradient-2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                    <i class="bi bi-file-earmark-text fs-2 text-white"></i>
                </div>
            </div>
            <div>
                <h1 class="display-5 fw-bold mb-2">{{ document.title }}</h1>
                <div class="d-flex flex-wrap align-items-center gap-2">
                    {% if document.access_level == 'open' %}
                    <span class="badge bg-success px-3 py-2">
                        <i class="bi bi-unlock me-1"></i>Open Access
                    </span>
                    {% elif document.access_level == 'restricted' %}
                    <span class="badge bg-warning px-3 py-2">
                        <i class="bi bi-lock me-1"></i>Restricted Access
                    </span>
                    {% elif document.access_level == 'embargo' %}
                    <span class="badge bg-secondary px-3 py-2">
                        <i class="bi bi-clock me-1"></i>Embargoed until {{ document.embargo_date|date:"Y-m-d" }}
                    </span>
                    {% else %}
                    <span class="badge bg-dark px-3 py-2">
                        <i class="bi bi-person me-1"></i>Private
                    </span>
                    {% endif %}
                    
                    {% if document.collection %}
                    <a href="{% url 'repository:collection_detail' pk=document.collection.pk %}" 
                       class="badge bg-primary px-3 py-2 text-decoration-none">
                        <i class="bi bi-folder me-1"></i>{{ document.collection.name }}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-4 text-lg-end">
        <div class="d-flex flex-wrap justify-content-lg-end gap-2">
            <a href="{% url 'repository:download_document' pk=document.pk %}" 
               class="btn btn-primary btn-lg">
                <i class="bi bi-download me-2"></i>Download
            </a>
            
            {% if user.is_staff %}
            <div class="btn-group">
                <a href="{% url 'repository:edit_document' pk=document.pk %}" 
                   class="btn btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'repository:delete_document' pk=document.pk %}" 
                   class="btn btn-outline-danger">
                    <i class="bi bi-trash"></i>
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Document Metadata -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h3 class="fw-bold mb-4">Document Information</h3>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-muted mb-2">
                            <i class="bi bi-person me-2"></i>Authors
                        </h6>
                        <p class="mb-0">{{ document.authors }}</p>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-muted mb-2">
                            <i class="bi bi-calendar me-2"></i>Upload Date
                        </h6>
                        <p class="mb-0">{{ document.upload_date|date:"F d, Y" }}</p>
                    </div>
                    
                    {% if document.doi %}
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-muted mb-2">
                            <i class="bi bi-tag me-2"></i>DOI
                        </h6>
                        <p class="mb-0">
                            <a href="https://doi.org/{{ document.doi }}" target="_blank" 
                               class="text-decoration-none">
                                {{ document.doi }}
                                <i class="bi bi-box-arrow-up-right ms-1"></i>
                            </a>
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="col-md-6 mb-3">
                        <h6 class="fw-bold text-muted mb-2">
                            <i class="bi bi-person-circle me-2"></i>Uploaded By
                        </h6>
                        <p class="mb-0">{{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}</p>
                    </div>
                    
                    {% if document.keywords %}
                    <div class="col-12 mb-3">
                        <h6 class="fw-bold text-muted mb-2">
                            <i class="bi bi-tags me-2"></i>Keywords
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for keyword in document.keywords_list %}
                            <span class="badge bg-light text-dark border">{{ keyword }}</span>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Abstract -->
        {% if document.abstract %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h3 class="fw-bold mb-4">Abstract</h3>
                <div class="abstract-content">
                    {{ document.abstract|linebreaks }}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- File Information -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h3 class="fw-bold mb-4">File Information</h3>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                {% if document.file.name|lower|slice:"-4:" == ".pdf" %}
                                <i class="bi bi-file-pdf fs-1 text-danger"></i>
                                {% elif document.file.name|lower|slice:"-5:" == ".docx" or document.file.name|lower|slice:"-4:" == ".doc" %}
                                <i class="bi bi-file-word fs-1 text-primary"></i>
                                {% elif document.file.name|lower|slice:"-5:" == ".pptx" or document.file.name|lower|slice:"-4:" == ".ppt" %}
                                <i class="bi bi-file-ppt fs-1 text-warning"></i>
                                {% elif document.file.name|lower|slice:"-5:" == ".xlsx" or document.file.name|lower|slice:"-4:" == ".xls" %}
                                <i class="bi bi-file-excel fs-1 text-success"></i>
                                {% elif document.file.name|lower|slice:"-5:" == ".txt" or document.file.name|lower|slice:"-5:" == ".text" %}
                                <i class="bi bi-file-text fs-1 text-secondary"></i>
                                {% else %}
                                <i class="bi bi-file-earmark fs-1 text-dark"></i>
                                {% endif %}
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">{{ document.file.name|slice:"12:" }}</h5>
                                <p class="text-muted mb-0">
                                    {{ document.file.size|filesizeformat }} â€¢ 
                                    {{ document.file.name|slice:"-4:"|upper }}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <a href="{% url 'repository:download_document' pk=document.pk %}" 
                           class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-download me-2"></i>Download File
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Citation Information -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-body p-4">
                <h3 class="fw-bold mb-4">How to Cite</h3>
                <div class="citation-box bg-light p-4 rounded-3 mb-3">
                    <code class="text-dark">
                        {{ document.authors }}. "{{ document.title }}". 
                        {% if document.collection %}In: {{ document.collection.name }}. {% endif %}
                        Ramat Library Institutional Repository, University of Maiduguri. 
                        {% if document.doi %}DOI: {{ document.doi }}{% else %}Accessed: {{ "now"|date:"Y-m-d" }}{% endif %}
                    </code>
                </div>
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-primary copy-citation" data-citation="{{ document.authors }}. &quot;{{ document.title }}&quot;. {% if document.collection %}In: {{ document.collection.name }}. {% endif %}Ramat Library Institutional Repository, University of Maiduguri. {% if document.doi %}DOI: {{ document.doi }}{% else %}Accessed: {{ 'now'|date:'Y-m-d' }}{% endif %}">
                        <i class="bi bi-clipboard me-2"></i>Copy Citation
                    </button>
                    <a href="mailto:?subject=Reference: {{ document.title|urlencode }}&body=Check out this document: {{ request.build_absolute_uri }}" 
                       class="btn btn-outline-secondary">
                        <i class="bi bi-envelope me-2"></i>Email
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Related Documents -->
        {% if related_documents %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h4 class="fw-bold mb-4">Related Documents</h4>
                <div class="list-group list-group-flush">
                    {% for related in related_documents %}
                    <a href="{% url 'repository:document_detail' pk=related.pk %}" 
                       class="list-group-item list-group-item-action border-0 px-0 py-3">
                        <div class="d-flex align-items-start">
                            <div class="me-3">
                                {% if related.access_level == 'open' %}
                                <span class="badge bg-success px-2 py-1">Open</span>
                                {% else %}
                                <span class="badge bg-secondary px-2 py-1">Restricted</span>
                                {% endif %}
                            </div>
                            <div>
                                <h6 class="fw-bold mb-1">{{ related.title|truncatechars:60 }}</h6>
                                <small class="text-muted">{{ related.authors|truncatechars:40 }}</small>
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Statistics -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h4 class="fw-bold mb-4">Document Statistics</h4>
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="bg-light rounded-3 p-3">
                            <h3 class="fw-bold text-primary mb-1">{{ document.download_count|default:"0" }}</h3>
                            <small class="text-muted">Downloads</small>
                        </div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="bg-light rounded-3 p-3">
                            <h3 class="fw-bold text-primary mb-1">{{ document.view_count|default:"1" }}</h3>
                            <small class="text-muted">Views</small>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="bi bi-info-circle me-1"></i>
                        Last accessed: {{ document.last_accessed|date:"M d, Y"|default:"Never" }}
                    </small>
                </div>
            </div>
        </div>

        <!-- Collection Information -->
        {% if document.collection %}
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-body p-4">
                <h4 class="fw-bold mb-4">
                    <i class="bi bi-folder me-2"></i>Collection
                </h4>
                <div class="d-flex align-items-start mb-3">
                    <div class="me-3">
                        <div class="bg-primary rounded-circle p-3">
                            <i class="bi bi-folder text-white"></i>
                        </div>
                    </div>
                    <div>
                        <h5 class="fw-bold mb-1">{{ document.collection.name }}</h5>
                        <p class="text-muted small mb-2">
                            {{ document.collection.documents.count }} document{{ document.collection.documents.count|pluralize }}
                        </p>
                        {% if document.collection.description %}
                        <p class="text-muted mb-3">{{ document.collection.description|truncatechars:100 }}</p>
                        {% endif %}
                    </div>
                </div>
                <a href="{% url 'repository:collection_detail' pk=document.collection.pk %}" 
                   class="btn btn-outline-primary w-100">
                    Browse Collection
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Share Document -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h4 class="fw-bold mb-4">Share</h4>
                <div class="d-flex justify-content-center gap-3">
                    <a href="https://twitter.com/intent/tweet?text={{ document.title|urlencode }}&url={{ request.build_absolute_uri|urlencode }}" 
                       target="_blank" class="social-share twitter">
                        <i class="bi bi-twitter fs-4"></i>
                    </a>
                    <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri|urlencode }}" 
                       target="_blank" class="social-share facebook">
                        <i class="bi bi-facebook fs-4"></i>
                    </a>
                    <a href="https://www.linkedin.com/shareArticle?mini=true&url={{ request.build_absolute_uri|urlencode }}&title={{ document.title|urlencode }}" 
                       target="_blank" class="social-share linkedin">
                        <i class="bi bi-linkedin fs-4"></i>
                    </a>
                    <a href="mailto:?subject=Check this document&body={{ document.title }} - {{ request.build_absolute_uri }}" 
                       class="social-share email">
                        <i class="bi bi-envelope fs-4"></i>
                    </a>
                </div>
                <div class="mt-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="document-url" 
                               value="{{ request.build_absolute_uri }}" readonly>
                        <button class="btn btn-outline-secondary copy-url" type="button">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Navigation -->
<div class="mt-5 pt-4 border-top">
    <div class="row">
        <div class="col-md-6">
            {% if previous_document %}
            <a href="{% url 'repository:document_detail' pk=previous_document.pk %}" 
               class="btn btn-outline-primary">
                <i class="bi bi-arrow-left me-2"></i>
                Previous: {{ previous_document.title|truncatechars:40 }}
            </a>
            {% endif %}
        </div>
        <div class="col-md-6 text-md-end">
            {% if next_document %}
            <a href="{% url 'repository:document_detail' pk=next_document.pk %}" 
               class="btn btn-outline-primary">
                Next: {{ next_document.title|truncatechars:40 }}
                <i class="bi bi-arrow-right ms-2"></i>
            </a>
            {% endif %}
        </div>
    </div>
</div>

<!-- Back to Repository -->
<div class="mt-4 text-center">
    <a href="{% url 'repository:document_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left-circle me-2"></i>Back to Repository
    </a>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    /* Custom Styles */
    .citation-box {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-left: 4px solid var(--primary-blue);
    }
    
    .abstract-content {
        line-height: 1.8;
        font-size: 1.05rem;
    }
    
    .social-share {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        text-decoration: none;
        transition: all 0.3s ease;
    }
    
    .social-share.twitter {
        color: #1DA1F2;
        background: rgba(29, 161, 242, 0.1);
    }
    
    .social-share.facebook {
        color: #1877F2;
        background: rgba(24, 119, 242, 0.1);
    }
    
    .social-share.linkedin {
        color: #0A66C2;
        background: rgba(10, 102, 194, 0.1);
    }
    
    .social-share.email {
        color: #EA4335;
        background: rgba(234, 67, 53, 0.1);
    }
    
    .social-share:hover {
        transform: translateY(-3px) scale(1.1);
    }
    
    .social-share.twitter:hover {
        background: #1DA1F2;
        color: white;
    }
    
    .social-share.facebook:hover {
        background: #1877F2;
        color: white;
    }
    
    .social-share.linkedin:hover {
        background: #0A66C2;
        color: white;
    }
    
    .social-share.email:hover {
        background: #EA4335;
        color: white;
    }
    
    /* Badge Styles */
    .badge {
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    /* List Group Custom */
    .list-group-item {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .list-group-item:last-child {
        border-bottom: none;
    }
    
    .list-group-item:hover {
        background-color: rgba(0, 31, 63, 0.02);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .display-5 {
            font-size: 2rem;
        }
        
        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Copy Citation Button
        const copyCitationBtn = document.querySelector('.copy-citation');
        if (copyCitationBtn) {
            copyCitationBtn.addEventListener('click', function() {
                const citation = this.getAttribute('data-citation');
                navigator.clipboard.writeText(citation).then(() => {
                    // Show success feedback
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check me-2"></i>Copied!';
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-success');
                    
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-primary');
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            });
        }
        
        // Copy URL Button
        const copyUrlBtn = document.querySelector('.copy-url');
        if (copyUrlBtn) {
            copyUrlBtn.addEventListener('click', function() {
                const urlInput = document.getElementById('document-url');
                urlInput.select();
                navigator.clipboard.writeText(urlInput.value).then(() => {
                    // Show success feedback
                    const originalIcon = this.innerHTML;
                    this.innerHTML = '<i class="bi bi-check"></i>';
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('btn-success');
                    
                    setTimeout(() => {
                        this.innerHTML = originalIcon;
                        this.classList.remove('btn-success');
                        this.classList.add('btn-outline-secondary');
                    }, 2000);
                });
            });
        }
        
        // Social share tracking
        const socialLinks = document.querySelectorAll('.social-share');
        socialLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                const platform = this.classList.contains('twitter') ? 'twitter' :
                               this.classList.contains('facebook') ? 'facebook' :
                               this.classList.contains('linkedin') ? 'linkedin' : 'email';
                
                // Send analytics event (in a real app, you'd use your analytics service)
                console.log(`Shared on ${platform}: ${document.title}`);
            });
        });
        
        // File icon animation
        const fileIcon = document.querySelector('.bi-file-pdf, .bi-file-word, .bi-file-ppt, .bi-file-excel, .bi-file-text, .bi-file-earmark');
        if (fileIcon) {
            fileIcon.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.2)';
                this.style.transition = 'transform 0.3s ease';
            });
            
            fileIcon.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        }
        
        // Statistics counter animation
        const statNumbers = document.querySelectorAll('.fw-bold.text-primary');
        statNumbers.forEach(stat => {
            const target = parseInt(stat.textContent);
            if (!isNaN(target)) {
                let current = 0;
                const increment = target / 20;
                const updateCounter = () => {
                    if (current < target) {
                        current += increment;
                        stat.textContent = Math.ceil(current);
                        requestAnimationFrame(updateCounter);
                    }
                };
                
                // Start when element comes into view
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            updateCounter();
                            observer.unobserve(entry.target);
                        }
                    });
                }, { threshold: 0.5 });
                
                observer.observe(stat);
            }
        });
        
        // Abstract expand/collapse (if very long)
        const abstractContent = document.querySelector('.abstract-content');
        if (abstractContent && abstractContent.textContent.length > 1000) {
            const originalContent = abstractContent.innerHTML;
            const shortContent = abstractContent.textContent.substring(0, 500) + '...';
            
            abstractContent.innerHTML = shortContent;
            
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'btn btn-link p-0 mt-2 text-decoration-none';
            toggleBtn.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Show more';
            
            let isExpanded = false;
            toggleBtn.addEventListener('click', function() {
                if (!isExpanded) {
                    abstractContent.innerHTML = originalContent;
                    this.innerHTML = '<i class="bi bi-chevron-up me-1"></i>Show less';
                    isExpanded = true;
                } else {
                    abstractContent.innerHTML = shortContent;
                    this.innerHTML = '<i class="bi bi-chevron-down me-1"></i>Show more';
                    isExpanded = false;
                }
            });
            
            abstractContent.parentElement.appendChild(toggleBtn);
        }
        
        // Download tracking (simulated)
        const downloadBtn = document.querySelector('a[href*="download"]');
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                // In a real app, you'd send an AJAX request to increment download count
                console.log(`Download initiated: ${document.title}`);
                
                // Simulate download delay
                setTimeout(() => {
                    // Update displayed count
                    const downloadCount = document.querySelector('.text-primary.mb-1');
                    if (downloadCount) {
                        const current = parseInt(downloadCount.textContent);
                        if (!isNaN(current)) {
                            downloadCount.textContent = current + 1;
                        }
                    }
                }, 1000);
            });
        }
    });
</script>
{% endblock %}