{% extends 'base.html' %}

{% block title %}{{ topic.name }} - Library Topic{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/catalog/">Catalog</a></li>
<li class="breadcrumb-item"><a href="/catalog/faculties/{{ topic.department.faculty.id }}/">{{ topic.department.faculty.name }}</a></li>
<li class="breadcrumb-item"><a href="/catalog/departments/{{ topic.department.id }}/">{{ topic.department.name }}</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ topic.name|truncatechars:30 }}</li>
{% endblock %}

{% block page_header %}
<div class="row mb-5 animate__animated animate__fadeIn">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap">
            <div class="d-flex align-items-start">
                <!-- Topic Avatar -->
                <div class="topic-header-avatar me-4 d-none d-md-block">
                    <div class="avatar-container rounded-circle d-flex align-items-center justify-content-center"
                         style="width: 120px; height: 120px; background: linear-gradient(135deg, #0a2472, #3a86ff);">
                        <span class="text-white fs-1 fw-bold">{{ topic.name|first|upper }}</span>
                    </div>
                </div>

                <!-- Topic Info -->
                <div>
                    <h1 class="display-4 fw-bold mb-2">{{ topic.name }}</h1>
                    <div class="mb-2">
                        <span class="badge bg-primary">
                            <i class="bi bi-building me-1"></i>{{ topic.department.faculty.name }}
                        </span>
                        <span class="badge bg-info">
                            <i class="bi bi-diagram-3 me-1"></i>{{ topic.department.name }}
                        </span>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                        <span class="badge bg-success">
                            <i class="bi bi-book me-1"></i>{{ topic.books.count }} books
                        </span>
                        {% if topic.description %}
                        <span class="badge bg-warning">
                            <i class="bi bi-info-circle me-1"></i>Description Available
                        </span>
                        {% endif %}
                    </div>
                    <p class="lead text-muted mb-0">
                        {% if topic.description %}
                        {{ topic.description|truncatechars:150 }}
                        {% else %}
                        Specialized academic topic covering key concepts and research areas within {{ topic.department.name }}.
                        {% endif %}
                    </p>
                </div>
            </div>
            <div class="mt-3 mt-md-0">
                {% if user.is_staff %}
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                        <i class="bi bi-gear me-1"></i>Manage
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="/admin/catalog/topic/{{ topic.id }}/change/">
                                <i class="bi bi-pencil me-2"></i>Edit Topic
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item" href="/admin/catalog/book/add/?topic={{ topic.id }}">
                                <i class="bi bi-plus-circle me-2"></i>Add Book
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" href="/admin/catalog/topic/{{ topic.id }}/delete/">
                                <i class="bi bi-trash me-2"></i>Delete Topic
                            </a>
                        </li>
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Topic Details Section -->
<div class="row mb-5">
    <!-- Topic Sidebar -->
    <div class="col-lg-4 mb-5 mb-lg-0">
        <div class="card border-0 shadow-lg sticky-top" style="top: 100px;">
            <div class="card-body p-4">
                <!-- Topic Portrait -->
                <div class="topic-portrait mb-4">
                    <div class="portrait-container rounded-4 overflow-hidden position-relative">
                        <div class="portrait-placeholder d-flex align-items-center justify-content-center"
                             style="height: 300px; background: linear-gradient(135deg, #0a2472, #3a86ff);">
                            <div class="text-center text-white">
                                <span class="display-1 fw-bold d-block">{{ topic.name|first|upper }}</span>
                                <span class="fs-5">{{ topic.name }}</span>
                            </div>
                        </div>
                        <div class="position-absolute top-0 start-0 m-3">
                            <span class="badge bg-success px-3 py-2 fs-6">
                                <i class="bi bi-tags me-1"></i>Topic
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Topic Stats -->
                <div class="topic-stats-card mb-4">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-4">Topic Statistics</h5>
                            <div class="stats-grid">
                                <div class="stat-item text-center mb-4">
                                    <div class="stat-number fw-bold text-primary fs-3 mb-2">
                                        {{ topic.books.count }}
                                    </div>
                                    <div class="stat-label text-muted">Total Books</div>
                                </div>
                                <div class="stat-item text-center mb-4">
                                    <div class="stat-number fw-bold text-success fs-3 mb-2">
                                        {{ available_books|default:topic.books.count }}
                                    </div>
                                    <div class="stat-label text-muted">Available Now</div>
                                </div>
                                <div class="stat-item text-center mb-4">
                                    <div class="stat-number fw-bold text-warning fs-3 mb-2">
                                        {{ topic.code|default:"N/A" }}
                                    </div>
                                    <div class="stat-label text-muted">Topic Code</div>
                                </div>
                                <div class="stat-item text-center mb-4">
                                    <div class="stat-number fw-bold text-info fs-3 mb-2">
                                        {{ recent_books|default:"0" }}
                                    </div>
                                    <div class="stat-label text-muted">Recent Additions</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions mb-4">
                    <div class="d-grid gap-2">
                        {% if user.is_authenticated %}
                        <button class="btn btn-outline-primary" id="followTopic">
                            <i class="bi bi-bell me-2"></i>
                            <span>Follow Topic</span>
                        </button>
                        {% endif %}
                        <button class="btn btn-outline-primary" onclick="printTopicDetails()">
                            <i class="bi bi-printer me-2"></i>
                            <span>Print Profile</span>
                        </button>
                        <button class="btn btn-outline-primary" onclick="shareTopic()">
                            <i class="bi bi-share me-2"></i>
                            <span>Share Profile</span>
                        </button>
                        <a href="/catalog/books/?topic={{ topic.id }}" class="btn btn-primary">
                            <i class="bi bi-book me-2"></i>
                            <span>View All Books</span>
                        </a>
                    </div>
                </div>

                <!-- Topic Information -->
                <div class="topic-info-card">
                    <div class="card border-0 bg-light">
                        <div class="card-body p-4">
                            <h6 class="fw-bold mb-3">Additional Information</h6>
                            <div class="info-list">
                                <div class="info-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-building text-primary me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Faculty</small>
                                            <span class="fw-bold">{{ topic.department.faculty.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-diagram-3 text-primary me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Department</small>
                                            <span class="fw-bold">{{ topic.department.name }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-item mb-3">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-hash text-primary me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Topic Code</small>
                                            <span class="fw-bold">{{ topic.code|default:"Not specified" }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-calendar text-primary me-3"></i>
                                        <div>
                                            <small class="text-muted d-block">Books in Collection</small>
                                            <span class="fw-bold">{{ topic.books.count }} books available</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topic Content -->
    <div class="col-lg-8">
        <!-- Description Section -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-transparent border-0 py-3">
                <h3 class="fw-bold mb-0">About {{ topic.name }}</h3>
            </div>
            <div class="card-body p-4">
                <div class="topic-description">
                    {% if topic.description %}
                    <div class="description-content">
                        {{ topic.description|linebreaks }}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="bi bi-tags text-muted fs-1 mb-3"></i>
                        <h5 class="text-muted mb-3">Description Not Available</h5>
                        <p class="text-muted">
                            Detailed information about this topic is currently being updated.
                            Check back soon for more information.
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Books in This Topic -->
        <div class="card border-0 shadow-lg mb-4">
            <div class="card-header bg-transparent border-0 py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h3 class="fw-bold mb-0">Books in {{ topic.name }}</h3>
                    <p class="text-muted mb-0 small">{{ topic.books.count }} books in this topic</p>
                </div>
                <span class="badge bg-success">{{ available_books|default:topic.books.count }} Available</span>
            </div>
            <div class="card-body p-4">
                {% if topic.books.exists %}
                <div class="row g-4">
                    {% for book in topic.books.all|slice:":12" %}
                    <div class="col-lg-6">
                        <div class="card book-card h-100 border-0 shadow-hover">
                            <div class="row g-0 h-100">
                                <div class="col-md-4">
                                    <div class="position-relative h-100">
                                        <img src="{% static 'images/librarybooks.jfif' %}" class="img-fluid rounded-start h-100"
                                             alt="{{ book.title }}" style="object-fit: cover;">
                                        {% if book.is_available %}
                                        <span class="position-absolute top-0 start-0 m-2 badge bg-success">
                                            Available
                                        </span>
                                        {% else %}
                                        <span class="position-absolute top-0 start-0 m-2 badge bg-warning">
                                            Checked Out
                                        </span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body d-flex flex-column h-100">
                                        <div class="flex-grow-1">
                                            <h6 class="card-title fw-bold mb-2">{{ book.title|truncatechars:50 }}</h6>
                                            <p class="card-text text-muted small mb-2">
                                                <i class="bi bi-person me-1"></i>
                                                {% for author in book.authors.all|slice:":1" %}
                                                {{ author.name }}
                                                {% endfor %}
                                            </p>
                                            <p class="card-text text-muted small mb-3">
                                                <i class="bi bi-building me-1"></i>{{ book.publisher.name|truncatechars:25 }}
                                            </p>
                                            <div class="mb-3">
                                                {% if book.genre %}
                                                <span class="badge bg-light text-dark">{{ book.genre.name }}</span>
                                                {% endif %}
                                                {% if book.publication_date.year >= 2023 %}
                                                <span class="badge bg-info">New</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mt-auto">
                                            <small class="text-muted">
                                                <i class="bi bi-calendar me-1"></i>{{ book.publication_date.year }}
                                            </small>
                                            <div>
                                                <a href="/catalog/books/{{ book.id }}/" class="btn btn-sm btn-primary">
                                                    <i class="bi bi-eye me-1"></i>View
                                                </a>
                                                {% if user.is_authenticated and book.is_available %}
                                                <a href="/circulation/reserve/{{ book.id }}/"
                                                   class="btn btn-sm btn-outline-primary ms-1">
                                                    Reserve
                                                </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {% if topic.books.count > 12 %}
                <div class="text-center mt-4">
                    <a href="/catalog/books/?topic={{ topic.id }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-arrow-right-circle me-2"></i>
                        View All {{ topic.books.count }} Books
                    </a>
                </div>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <i class="bi bi-book text-muted fs-1 mb-3"></i>
                    <h5 class="text-muted mb-3">No Books Found</h5>
                    <p class="text-muted mb-4">
                        This topic currently has no books in our collection.
                    </p>
                    {% if user.is_staff %}
                    <a href="/admin/catalog/book/add/?topic={{ topic.id }}"
                       class="btn btn-primary">
                        <i class="bi bi-plus-circle me-2"></i>Add First Book
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Topic Statistics Chart -->
        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">Publication Timeline</h5>
                        <div class="timeline">
                            {% for year_data in publication_years|slice:":6" %}
                            <div class="timeline-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">{{ year_data.year }}</span>
                                    <span class="text-muted">{{ year_data.count }} books</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-primary"
                                         style="width: {% widthratio year_data.count topic.books.count 100 %}%;">
                                    </div>
                                </div>
                                <small class="text-muted">Published this year</small>
                            </div>
                            {% empty %}
                            <div class="text-center py-4">
                                <i class="bi bi-calendar text-muted fs-1 mb-3"></i>
                                <p class="text-muted">No publication data available</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-4">Top Genres in {{ topic.name }}</h5>
                        <div class="genres-chart">
                            {% for genre_data in top_genres|slice:":5" %}
                            <div class="genre-item mb-3">
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="fw-bold">{{ genre_data.name }}</span>
                                    <span class="text-muted">{{ genre_data.count }} books</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar bg-success"
                                         style="width: {% widthratio genre_data.count topic.books.count 100 %}%;">
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4">
                                <i class="bi bi-tags text-muted fs-1 mb-3"></i>
                                <p class="text-muted">No genre data available</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Related Topics -->
        <div class="card border-0 shadow-lg">
            <div class="card-header bg-transparent border-0 py-3">
                <h3 class="fw-bold mb-0">Related Topics in {{ topic.department.name }}</h3>
                <p class="text-muted mb-0 small">Explore other topics in this department</p>
            </div>
            <div class="card-body p-4">
                <div class="row g-4">
                    {% for related_topic in related_topics|slice:":4" %}
                    <div class="col-lg-3 col-md-6">
                        <div class="related-topic-card">
                            <div class="card border-0 shadow-sm h-100">
                                <div class="card-body p-3 text-center">
                                    <div class="related-topic-avatar mb-3 mx-auto">
                                        <div class="rounded-circle d-flex align-items-center justify-content-center"
                                             style="width: 80px; height: 80px; background: linear-gradient(135deg,
                                                    {% cycle '#0a2472' '#001f3f' '#3a86ff' '#4361ee' as bgcolor %},
                                                    {% cycle '#3a86ff' '#4361ee' '#0a2472' '#001f3f' as bgcolor2 %});">
                                            <span class="text-white fw-bold">{{ related_topic.name|first|upper }}</span>
                                        </div>
                                    </div>
                                    <h6 class="fw-bold mb-2">{{ related_topic.name|truncatechars:20 }}</h6>
                                    <p class="text-muted small mb-3">
                                        {{ related_topic.books.count }} books
                                    </p>
                                    <a href="/catalog/topics/{{ related_topic.id }}/"
                                       class="btn btn-sm btn-outline-primary">
                                        View Topic
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="col-12">
                        <div class="text-center py-4">
                            <i class="bi bi-tags text-muted fs-1 mb-3"></i>
                            <p class="text-muted">No related topics available</p>
                            <a href="/catalog/departments/{{ topic.department.id }}/" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-right me-2"></i>Back to Department
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    /* Topic Detail Specific Styles */
    .topic-header-avatar .avatar-container {
        box-shadow: 0 10px 30px rgba(0, 31, 63, 0.2);
        transition: transform 0.3s ease;
    }

    .topic-header-avatar:hover .avatar-container {
        transform: scale(1.05);
    }

    .portrait-container {
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        transition: transform 0.3s ease;
    }

    .portrait-container:hover {
        transform: scale(1.02);
    }

    .portrait-placeholder {
        background-size: cover;
        background-position: center;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .stat-item {
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .stat-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Quick Actions */
    .quick-actions .btn {
        transition: all 0.2s ease;
    }

    .quick-actions .btn:hover {
        transform: translateY(-2px);
    }

    /* Info List */
    .info-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .info-item:last-child {
        border-bottom: none;
    }

    /* Description */
    .description-content {
        line-height: 1.8;
        color: var(--dark-text);
    }

    /* Book Cards */
    .book-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .book-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15) !important;
    }

    .book-card .card-img-top {
        transition: transform 0.5s ease;
    }

    .book-card:hover .card-img-top {
        transform: scale(1.05);
    }

    /* Charts */
    .timeline .progress-bar,
    .genres-chart .progress-bar {
        border-radius: 4px;
        transition: width 0.5s ease;
    }

    .timeline-item:hover .progress-bar,
    .genre-item:hover .progress-bar {
        opacity: 0.9;
    }

    /* Related Topics */
    .related-topic-card .card {
        transition: all 0.3s ease;
    }

    .related-topic-card .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
    }

    .related-topic-avatar {
        transition: all 0.3s ease;
    }

    .related-topic-card:hover .related-topic-avatar {
        transform: scale(1.1);
    }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .topic-header-avatar {
            margin-right: 1rem;
            margin-bottom: 1rem;
        }

        .topic-header-avatar .avatar-container {
            width: 80px;
            height: 80px;
        }

        .topic-header-avatar .avatar-container span {
            font-size: 1.5rem;
        }

        .portrait-container {
            height: 200px;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .book-card {
            margin-bottom: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Follow Topic functionality
        const followBtn = document.getElementById('followTopic');
        if (followBtn) {
            followBtn.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.createElement('div'));
                const modalElement = document.createElement('div');
                modalElement.className = 'modal fade';
                modalElement.innerHTML = `
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title fw-bold">Follow {{ topic.name }}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p>Get notifications when new books are added to <strong>{{ topic.name }}</strong>.</p>
                                <div class="mb-3">
                                    <label class="form-label">Notification Preferences</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="newBooksNotify" checked>
                                        <label class="form-check-label" for="newBooksNotify">
                                            New book additions
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="updatesNotify" checked>
                                        <label class="form-check-label" for="updatesNotify">
                                            Topic updates
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="followTopic()">
                                    Start Following
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modalElement);
                const bsModal = new bootstrap.Modal(modalElement);
                bsModal.show();

                // Remove from DOM after hiding
                modalElement.addEventListener('hidden.bs.modal', function() {
                    document.body.removeChild(modalElement);
                });
            });
        }

        // Follow topic function
        window.followTopic = function() {
            const newBooksNotify = document.getElementById('newBooksNotify').checked;
            const updatesNotify = document.getElementById('updatesNotify').checked;

            // Show loading state
            const modal = bootstrap.Modal.getInstance(document.querySelector('.modal'));
            const followBtn = modal._element.querySelector('.btn-primary');
            const originalText = followBtn.innerHTML;

            followBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Following...';
            followBtn.disabled = true;

            // Simulate API call
            setTimeout(() => {
                // Success
                showToast(`Now following ${topic.name}!`, 'success');

                // Update modal
                modal.hide();

                // Update follow button
                const mainFollowBtn = document.getElementById('followTopic');
                if (mainFollowBtn) {
                    const icon = mainFollowBtn.querySelector('i');
                    const text = mainFollowBtn.querySelector('span');

                    icon.className = 'bi bi-bell-fill me-2';
                    text.textContent = 'Following';
                    mainFollowBtn.classList.add('btn-primary');
                    mainFollowBtn.classList.remove('btn-outline-primary');
                }

                // Reset modal button
                followBtn.innerHTML = originalText;
                followBtn.disabled = false;
            }, 1500);
        };

        // Print topic details
        window.printTopicDetails = function() {
            window.print();
        };

        // Share topic profile
        window.shareTopic = function() {
            if (navigator.share) {
                navigator.share({
                    title: `${topic.name} - Library Topic`,
                    text: `Explore books in ${topic.name} at Ramat Library`,
                    url: window.location.href,
                })
                .then(() => showToast('Topic profile shared successfully!', 'success'))
                .catch(error => {
                    console.log('Error sharing:', error);
                    copyToClipboard(window.location.href);
                    showToast('Profile link copied to clipboard', 'info');
                });
            } else {
                copyToClipboard(window.location.href);
                showToast('Profile link copied to clipboard', 'info');
            }
        };

        // Helper function to copy to clipboard
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastId = 'toast-' + Date.now();
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed`;
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '1060';

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
            `;

            document.body.appendChild(toast);

            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });

            bsToast.show();

            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        // Book card hover effects
        const bookCards = document.querySelectorAll('.book-card');
        bookCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                const image = this.querySelector('img');
                const badges = this.querySelectorAll('.badge');

                if (image) {
                    image.style.transform = 'scale(1.05)';
                }

                badges.forEach(badge => {
                    badge.style.transform = 'scale(1.1)';
                });
            });

            card.addEventListener('mouseleave', function() {
                const image = this.querySelector('img');
                const badges = this.querySelectorAll('.badge');

                if (image) {
                    image.style.transform = 'scale(1)';
                }

                badges.forEach(badge => {
                    badge.style.transform = 'scale(1)';
                });
            });
        });

        // Related topic card effects
        const relatedTopicCards = document.querySelectorAll('.related-topic-card');
        relatedTopicCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                const avatar = this.querySelector('.related-topic-avatar');
                const button = this.querySelector('.btn');

                if (avatar) {
                    avatar.style.transform = 'scale(1.1)';
                }
                if (button) {
                    button.classList.add('btn-primary');
                    button.classList.remove('btn-outline-primary');
                }
            });

            card.addEventListener('mouseleave', function() {
                const avatar = this.querySelector('.related-topic-avatar');
                const button = this.querySelector('.btn');

                if (avatar) {
                    avatar.style.transform = 'scale(1)';
                }
                if (button) {
                    button.classList.remove('btn-primary');
                    button.classList.add('btn-outline-primary');
                }
            });
        });

        // Topic avatar hover effect
        const topicAvatar = document.querySelector('.topic-header-avatar .avatar-container');
        if (topicAvatar) {
            topicAvatar.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05) rotate(5deg)';
            });

            topicAvatar.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1) rotate(0)';
            });
        }

        // Portrait container hover effect
        const portraitContainer = document.querySelector('.portrait-container');
        if (portraitContainer) {
            portraitContainer.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.02)';
            });

            portraitContainer.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        }

        // Stats item hover effects
        const statItems = document.querySelectorAll('.stat-item');
        statItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                const number = this.querySelector('.stat-number');
                if (number) {
                    number.style.transform = 'scale(1.1)';
                }
            });

            item.addEventListener('mouseleave', function() {
                const number = this.querySelector('.stat-number');
                if (number) {
                    number.style.transform = 'scale(1)';
                }
            });
        });

        // Animate stats on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const statNumbers = entry.target.querySelectorAll('.stat-number');
                    statNumbers.forEach((stat, index) => {
                        setTimeout(() => {
                            stat.classList.add('animate__animated', 'animate__pulse');
                        }, index * 200);
                    });
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.5 });

        const statsCard = document.querySelector('.topic-stats-card');
        if (statsCard) {
            observer.observe(statsCard);
        }
    });
</script>
{% endblock %}
