{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - Ramat Library{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'catalog:home' %}" class="text-decoration-none">
    <i class="bi bi-house-door me-1"></i>Home
</a></li>
<li class="breadcrumb-item"><a href="{% url 'accounts:login' %}" class="text-decoration-none">
    <i class="bi bi-box-arrow-in-right me-1"></i>Login
</a></li>
<li class="breadcrumb-item active" aria-current="page">Reset Password</li>
{% endblock %}

{% block page_header %}
<div class="row mb-5 animate__animated animate__fadeInUp">
    <div class="col">
        <div class="d-flex align-items-center mb-3">
            <div class="me-3">
                <div class="icon-60 icon-60--gradient">
                    <i class="bi bi-key fs-3 text-white"></i>
                </div>
            </div>
            <div>
                <h1 class="display-4 fw-bold mb-2">Reset Your Password</h1>
                <p class="lead text-muted">Enter your email to receive password reset instructions</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Password Reset Page Content -->
<div class="password-reset-page">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-6">
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <h3 class="fw-bold mb-2">Forgot Your Password?</h3>
                            <p class="text-muted">No worries! We'll send you a link to reset your password.</p>
                        </div>
                        
                        <!-- Password Reset Form -->
                        <form method="post" id="passwordResetForm" novalidate>
                            {% csrf_token %}
                            
                            <!-- Email Field -->
                            <div class="mb-4">
                                <label for="email" class="form-label">Email Address *</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0">
                                        <i class="bi bi-envelope"></i>
                                    </span>
                                    <input type="email" 
                                           class="form-control {% if form.email.errors %}is-invalid{% endif %}" 
                                           id="email" 
                                           name="email" 
                                           value="{{ form.email.value|default:'' }}"
                                           placeholder="Enter your registered email address"
                                           required
                                           autofocus>
                                    {% if form.email.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.email.errors.0 }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="form-text">
                                    We'll send password reset instructions to this email address
                                </div>
                            </div>
                            
                            <!-- Error Messages -->
                            {% if form.non_field_errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    <div>{{ form.non_field_errors.0 }}</div>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                            {% endif %}
                            
                            <!-- Submit Button -->
                            <div class="d-grid mb-4">
                                <button type="submit" class="btn btn-primary btn-lg" id="resetBtn">
                                    <i class="bi bi-send me-2"></i>Send Reset Link
                                </button>
                            </div>
                            
                            <!-- Security Notice -->
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-shield-check-fill fs-4 me-3"></i>
                                    <div>
                                        <strong>Security Notice:</strong> Password reset links are valid for 24 hours. 
                                        If you didn't request this, please ignore this email.
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Back to Login -->
                            <div class="text-center">
                                <p class="text-muted mb-0">
                                    Remember your password?
                                    <a href="{% url 'accounts:login' %}" class="text-decoration-none fw-bold">
                                        Sign in here
                                    </a>
                                </p>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Additional Help Section -->
                <div class="row mt-4">
                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-envelope me-2"></i>Email Not Received?
                                </h6>
                                <p class="text-muted small mb-3">
                                    Check your spam folder or contact support if you don't receive the email within 5 minutes.
                                </p>
                                <a href="{% url 'accounts:contact' %}" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-envelope me-1"></i>Contact Support
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body p-4">
                                <h6 class="fw-bold mb-3">
                                    <i class="bi bi-question-circle me-2"></i>Need Help?
                                </h6>
                                <p class="text-muted small mb-3">
                                    If you're having trouble resetting your password, our support team is here to help.
                                </p>
                                <div class="d-grid">
                                    <a href="{% url 'accounts:contact' %}" class="btn btn-outline-secondary btn-sm">
                                        <i class="bi bi-headset me-1"></i>Get Help
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    /* Password Reset Specific Styles */
    .password-reset-page {
        padding-bottom: 4rem;
    }
    
    /* Form Styling */
    .input-group .form-control {
        border-left: none;
    }
    
    .input-group .input-group-text {
        border-right: none;
    }
    
    .input-group:focus-within {
        box-shadow: 0 0 0 0.25rem rgba(58, 134, 255, 0.25);
        border-radius: 8px;
    }
    
    /* Security Notice Styling */
    .alert-info {
        border-left: 4px solid var(--info-blue);
    }
    
    /* Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate__fadeInUp {
        animation: fadeInUp 0.6s ease-out;
    }
    
    /* Hover Effects */
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .password-reset-page {
            padding-bottom: 2rem;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Form submission handling
        const resetForm = document.getElementById('passwordResetForm');
        const resetBtn = document.getElementById('resetBtn');
        
        if (resetForm) {
            resetForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Basic validation
                const email = document.getElementById('email').value.trim();
                
                if (!email) {
                    showToast('error', 'Please enter your email address');
                    return;
                }
                
                // Email format validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('error', 'Please enter a valid email address');
                    return;
                }
                
                // Show loading state
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
                resetBtn.disabled = true;
                
                // Simulate form submission (in real app, this submits the form)
                setTimeout(() => {
                    // Check if email exists in demo data
                    if (isDemoEmail(email)) {
                        showSuccessMessage(email);
                    } else {
                        showErrorMessage();
                    }
                    
                    resetBtn.innerHTML = originalText;
                    resetBtn.disabled = false;
                }, 1500);
            });
        }
        
        // Demo email check (for demonstration)
        function isDemoEmail(email) {
            const demoEmails = [
                'demo@unimaid.edu.ng',
                'student@unimaid.edu.ng', 
                'faculty@unimaid.edu.ng',
                'admin@unimaid.edu.ng'
            ];
            return demoEmails.includes(email.toLowerCase());
        }
        
        // Show success message
        function showSuccessMessage(email) {
            // Create success overlay
            const successOverlay = document.createElement('div');
            successOverlay.className = 'success-overlay';
            successOverlay.innerHTML = `
                <div class="success-content text-center">
                    <div class="mb-4">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #198754, #20c997); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <i class="bi bi-check-lg text-white fs-1"></i>
                        </div>
                    </div>
                    <h4 class="fw-bold mb-3">Reset Link Sent!</h4>
                    <p class="text-muted mb-4">We've sent password reset instructions to <strong>${email}</strong></p>
                    <div class="alert alert-info alert-dismissible fade show">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle me-2"></i>
                            <div>
                                <strong>Check your email</strong> - Instructions have been sent to your email address. 
                                The link is valid for 24 hours.
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" onclick="location.href='/'">
                        <i class="bi bi-house me-2"></i>Return to Home
                    </button>
                </div>
            `;
            
            // Style the overlay
            successOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.95);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            document.body.appendChild(successOverlay);
            
            // Auto-redirect after 5 seconds
            setTimeout(() => {
                if (successOverlay.parentNode) {
                    successOverlay.remove();
                    location.href = '/';
                }
            }, 5000);
        }
        
        // Show error message
        function showErrorMessage() {
            // Create error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-warning alert-dismissible fade show';
            errorDiv.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <div>
                        <strong>Email not found</strong>
                        <p class="mb-0 small">No account found with this email address. Please check and try again.</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Insert after form
            const form = document.getElementById('passwordResetForm');
            const existingAlert = form.querySelector('.alert.alert-danger, .alert.alert-warning');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            form.parentNode.insertBefore(errorDiv, form.nextSibling);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }
        
        // Toast notification function
        function showToast(type, message) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}-fill fs-4 me-3"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Enter key to submit form
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.id === 'email') {
                if (!e.shiftKey) {
                    e.preventDefault();
                    resetForm.dispatchEvent(new Event('submit'));
                }
            }
        });
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
</script>
{% endblock %}