{% extends 'base.html' %}
{% load static %}

{% block title %}Security Settings - Ramat Library{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'accounts:dashboard' %}" class="text-decoration-none">
    <i class="bi bi-speedometer2 me-1"></i>Dashboard
</a></li>
<li class="breadcrumb-item"><a href="{% url 'accounts:profile' %}" class="text-decoration-none">
    <i class="bi bi-person me-1"></i>Profile
</a></li>
<li class="breadcrumb-item active" aria-current="page">Security Settings</li>
{% endblock %}

{% block page_header %}
<div class="row mb-5 animate__animated animate__fadeInUp">
    <div class="col">
        <div class="d-flex align-items-center mb-3">
            <div class="me-3">
                <div class="icon-60 icon-60--gradient">
                    <i class="bi bi-shield-check fs-3 text-white"></i>
                </div>
            </div>
            <div>
                <h1 class="display-4 fw-bold mb-2">Security Settings</h1>
                <p class="lead text-muted">Manage your account security and privacy settings</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Security Settings Page Content -->
<div class="security-settings-page">
    <div class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Security Overview -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h4 class="fw-bold mb-1">Account Security Overview</h4>
                                <p class="text-muted mb-0">Your current security status and recommendations</p>
                            </div>
                            <div class="badge bg-success">
                                <i class="bi bi-shield-check me-1"></i>Secure
                            </div>
                        </div>
                        
                        <!-- Security Score -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="security-score">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0">Security Score</h6>
                                        <span class="badge bg-primary ms-auto">85%</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar bg-success" style="width: 85%"></div>
                                    </div>
                                    <small class="text-muted">Based on your current security settings</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="security-actions">
                                    <h6 class="mb-2">Quick Actions</h6>
                                    <div class="d-grid gap-2">
                                        <a href="{% url 'accounts:change_password' %}" class="btn btn-outline-primary btn-sm">
                                            <i class="bi bi-key me-2"></i>Change Password
                                        </a>
                                        <a href="{% url 'accounts:account_activity' %}" class="btn btn-outline-info btn-sm">
                                            <i class="bi bi-clock me-2"></i>View Activity
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Two-Factor Authentication -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h5 class="fw-bold mb-1">Two-Factor Authentication</h5>
                                <p class="text-muted mb-0">Add an extra layer of security to your account</p>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="twoFactorToggle" 
                                       {% if security_info.two_factor_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="twoFactorToggle">
                                    {% if security_info.two_factor_enabled %}Enabled{% else %}Disabled{% endif %}
                                </label>
                            </div>
                        </div>
                        
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-info-circle me-3 fs-4"></i>
                                <div>
                                    <strong>What is Two-Factor Authentication?</strong>
                                    <p class="mt-2 mb-0">
                                        Two-factor authentication (2FA) adds an extra layer of security by requiring a second form of verification 
                                        when you sign in. This helps protect your account even if someone knows your password.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">Benefits of 2FA:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Prevents unauthorized access</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Protects against password theft</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Enhances account security</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">How to Set Up:</h6>
                                <ol class="list-unstyled">
                                    <li><span class="badge bg-primary me-2">1</span>Download an authenticator app</li>
                                    <li><span class="badge bg-primary me-2">2</span>Scan the QR code</li>
                                    <li><span class="badge bg-primary me-2">3</span>Enter the verification code</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Account Activity -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center justify-content-between mb-3">
                            <div>
                                <h5 class="fw-bold mb-1">Account Activity</h5>
                                <p class="text-muted mb-0">Recent activity and security events</p>
                            </div>
                            <a href="{% url 'accounts:account_activity' %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-eye me-2"></i>View All Activity
                            </a>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="activity-item">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-circle bg-success me-3">
                                            <i class="bi bi-check-circle text-white"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Last Password Change</h6>
                                            <small class="text-muted">
                                                {% if security_info.last_password_change %}
                                                    {{ security_info.last_password_change|date:"M d, Y H:i" }}
                                                {% else %}
                                                    Never
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="activity-item">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-circle bg-info me-3">
                                            <i class="bi bi-clock text-white"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Last Activity</h6>
                                            <small class="text-muted">
                                                {% if security_info.last_activity %}
                                                    {{ security_info.last_activity|date:"M d, Y H:i" }}
                                                {% else %}
                                                    Never
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="activity-item">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-circle bg-warning me-3">
                                            <i class="bi bi-exclamation-triangle text-white"></i>
                                        </div>
                                        <div>
                                            <h6 class="mb-0">Failed Attempts</h6>
                                            <small class="text-muted">
                                                {{ security_info.failed_attempts }} attempts
                                                {% if security_info.locked_until %}
                                                    (Locked until {{ security_info.locked_until|date:"M d, Y H:i" }})
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Recommendations -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Security Recommendations</h5>
                        
                        <div class="security-recommendations">
                            <div class="recommendation-item mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="icon-circle bg-warning me-3">
                                        <i class="bi bi-shield-exclamation text-white"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold">Enable Two-Factor Authentication</h6>
                                        <p class="text-muted mb-2">
                                            Add an extra layer of security to protect your account from unauthorized access.
                                        </p>
                                        <button class="btn btn-warning btn-sm" onclick="toggle2FA()">
                                            <i class="bi bi-shield-check me-2"></i>Enable 2FA
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="recommendation-item mb-3">
                                <div class="d-flex align-items-start">
                                    <div class="icon-circle bg-info me-3">
                                        <i class="bi bi-key text-white"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold">Update Your Password</h6>
                                        <p class="text-muted mb-2">
                                            Use a strong, unique password that you don't use elsewhere.
                                        </p>
                                        <a href="{% url 'accounts:change_password' %}" class="btn btn-info btn-sm">
                                            <i class="bi bi-key me-2"></i>Change Password
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="recommendation-item">
                                <div class="d-flex align-items-start">
                                    <div class="icon-circle bg-success me-3">
                                        <i class="bi bi-eye text-white"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="fw-bold">Review Account Activity</h6>
                                        <p class="text-muted mb-2">
                                            Regularly check your account activity for any suspicious behavior.
                                        </p>
                                        <a href="{% url 'accounts:account_activity' %}" class="btn btn-success btn-sm">
                                            <i class="bi bi-eye me-2"></i>View Activity
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Tools -->
                <div class="card border-0 shadow-lg mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Security Tools</h5>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-primary me-3">
                                                <i class="bi bi-shield-lock text-white"></i>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-1">Reset Failed Attempts</h6>
                                                <p class="text-muted mb-0">Clear failed login attempt count</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm" onclick="resetFailedAttempts()">
                                            <i class="bi bi-arrow-clockwise me-2"></i>Reset Attempts
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <div class="card border-0 h-100">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="icon-circle bg-danger me-3">
                                                <i class="bi bi-person-x text-white"></i>
                                            </div>
                                            <div>
                                                <h6 class="fw-bold mb-1">Delete Account</h6>
                                                <p class="text-muted mb-0">Request account deletion</p>
                                            </div>
                                        </div>
                                        <button class="btn btn-outline-danger btn-sm" onclick="showDeleteModal()">
                                            <i class="bi bi-trash me-2"></i>Delete Account
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Security Tips -->
                <div class="card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Security Best Practices</h5>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">Password Security</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Use strong, unique passwords</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Enable two-factor authentication</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Don't share your password</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Use a password manager</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-2">Account Protection</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Keep your email verified</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Monitor account activity</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Log out from shared devices</li>
                                    <li><i class="bi bi-check-circle text-success me-2"></i>Report suspicious activity</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Account Modal -->
<div class="modal fade" id="deleteAccountModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Delete Account</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle me-3 fs-4"></i>
                        <div>
                            <strong>Warning:</strong> This action cannot be undone. Your account will be deactivated and you will lose access to all library services.
                        </div>
                    </div>
                </div>
                
                <p class="text-muted">
                    To proceed with account deletion, please enter your password to confirm this action.
                </p>
                
                <form id="deleteAccountForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="deletePassword" class="form-label">Confirm Password</label>
                        <input type="password" class="form-control" id="deletePassword" placeholder="Enter your password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAccount()">
                    <i class="bi bi-trash me-2"></i>Delete Account
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    /* Security Settings Specific Styles */
    .security-settings-page {
        padding-bottom: 4rem;
    }
    
    /* Icon Circles */
    .icon-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Security Score */
    .security-score .progress {
        height: 8px;
        border-radius: 4px;
    }
    
    /* Activity Items */
    .activity-item {
        padding: 15px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .activity-item:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    
    /* Recommendation Items */
    .recommendation-item {
        padding: 20px;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        transition: all 0.3s ease;
    }
    
    .recommendation-item:hover {
        border-color: #0d6efd;
        background-color: #f8f9fa;
    }
    
    /* Form Styling */
    .form-check-input:checked {
        background-color: #198754;
        border-color: #198754;
    }
    
    /* Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate__fadeInUp {
        animation: fadeInUp 0.6s ease-out;
    }
    
    /* Hover Effects */
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .security-settings-page {
            padding-bottom: 2rem;
        }
        
        .card-body {
            padding: 1.5rem !important;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Two-Factor Authentication Toggle
        const twoFactorToggle = document.getElementById('twoFactorToggle');
        if (twoFactorToggle) {
            twoFactorToggle.addEventListener('change', function() {
                const isEnabled = this.checked;
                const action = isEnabled ? 'enable' : 'disable';
                
                // Show loading state
                const originalText = this.checked ? 'Enabled' : 'Disabled';
                const label = this.nextElementSibling;
                label.textContent = 'Updating...';
                
                // Send AJAX request
                fetch('{% url "accounts:security_settings" %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: new URLSearchParams({
                        'action': 'toggle_2fa'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        label.textContent = data.two_factor_enabled ? 'Enabled' : 'Disabled';
                        showToast('success', data.message);
                        
                        // Update security score
                        updateSecurityScore();
                    } else {
                        // Revert toggle
                        this.checked = !this.checked;
                        label.textContent = !this.checked ? 'Enabled' : 'Disabled';
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Revert toggle
                    this.checked = !this.checked;
                    label.textContent = !this.checked ? 'Enabled' : 'Disabled';
                    showToast('error', 'An error occurred while updating your security settings');
                });
            });
        }
        
        // Reset Failed Attempts
        window.resetFailedAttempts = function() {
            if (confirm('Are you sure you want to reset failed login attempts? This will unlock your account if it was locked.')) {
                fetch('{% url "accounts:security_settings" %}', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: new URLSearchParams({
                        'action': 'reset_failed_attempts'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('success', data.message);
                        // Update the failed attempts display
                        updateFailedAttemptsDisplay(data.failed_attempts, data.locked_until);
                    } else {
                        showToast('error', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('error', 'An error occurred while resetting failed attempts');
                });
            }
        };
        
        // Show Delete Account Modal
        window.showDeleteModal = function() {
            const modal = new bootstrap.Modal(document.getElementById('deleteAccountModal'));
            modal.show();
        };
        
        // Confirm Delete Account
        window.confirmDeleteAccount = function() {
            const password = document.getElementById('deletePassword').value;
            
            if (!password) {
                showToast('error', 'Please enter your password to confirm account deletion');
                return;
            }
            
            // Send AJAX request
            fetch('{% url "accounts:delete_account" %}', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
                body: new URLSearchParams({
                    'password': password
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('success', data.message);
                    // Redirect to home after a short delay
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    showToast('error', data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('error', 'An error occurred while deleting your account');
            });
        };
        
        // Update Security Score
        function updateSecurityScore() {
            const twoFactorEnabled = document.getElementById('twoFactorToggle').checked;
            const score = twoFactorEnabled ? 95 : 75;
            
            const progressBar = document.querySelector('.progress-bar');
            const scoreBadge = document.querySelector('.badge.bg-primary');
            
            progressBar.style.width = score + '%';
            scoreBadge.textContent = score + '%';
            
            if (score >= 90) {
                progressBar.className = 'progress-bar bg-success';
            } else if (score >= 70) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }
        
        // Update Failed Attempts Display
        function updateFailedAttemptsDisplay(attempts, lockedUntil) {
            const failedAttemptsElement = document.querySelector('.activity-item:last-child small.text-muted');
            if (failedAttemptsElement) {
                let text = `${attempts} attempts`;
                if (lockedUntil) {
                    text += ` (Locked until ${lockedUntil})`;
                }
                failedAttemptsElement.textContent = text;
            }
        }
        
        // Toast notification function
        function showToast(type, message) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}-fill fs-4 me-3"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add confetti effect for security enabled
        if (document.getElementById('twoFactorToggle').checked) {
            createConfetti();
        }
        
        // Confetti effect
        function createConfetti() {
            const colors = ['#198754', '#20c997', '#0d6efd', '#ffc107', '#dc3545'];
            const container = document.body;
            
            for (let i = 0; i < 30; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.top = '-10px';
                confetti.style.width = '8px';
                confetti.style.height = '8px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.transform = 'rotate(' + Math.random() * 360 + 'deg)';
                confetti.style.zIndex = '9999';
                confetti.style.pointerEvents = 'none';
                confetti.style.animation = 'fall ' + (Math.random() * 3 + 2) + 's linear forwards';
                
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }
        
        // Add CSS for confetti animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fall {
                to {
                    transform: translateY(100vh) rotate(360deg);
                }
            }
        `;
        document.head.appendChild(style);
    });
</script>
{% endblock %}