{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard - Ramat Library{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item active" aria-current="page">My Dashboard</li>
{% endblock %}

{% block page_header %}
<div class="row mb-5 animate__animated animate__fadeInUp">
    <div class="col">
        <div class="d-flex align-items-center mb-3">
            <div class="me-3">
                <div class="icon-60 icon-60--gradient">
                    <i class="bi bi-speedometer2 fs-3 text-white"></i>
                </div>
            </div>
            <div>
                <h1 class="display-4 fw-bold mb-2">Welcome back, {{ user.first_name|default:user.username }}!</h1>
                <p class="lead text-muted">Manage your library account, loans, and activities</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Dashboard Content -->
<div class="dashboard-page">
    <div class="container-fluid">
        <!-- Quick Stats Row -->
        <div class="row mb-4">
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card bg-primary text-white border-0 shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="stat-icon" style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-book fs-3"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="stat-number display-6 fw-bold">{{ current_loans|length|default:"0" }}</div>
                                <div class="stat-label">Active Loans</div>
                            </div>
                        </div>
                        <a href="#loans-section" class="stretched-link text-white text-decoration-none">
                            <small>View all <i class="bi bi-arrow-right ms-1"></i></small>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card bg-success text-white border-0 shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="stat-icon" style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-clock-history fs-3"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="stat-number display-6 fw-bold">{{ reservations|length|default:"0" }}</div>
                                <div class="stat-label">Pending Reservations</div>
                            </div>
                        </div>
                        <a href="#reservations-section" class="stretched-link text-white text-decoration-none">
                            <small>Manage <i class="bi bi-arrow-right ms-1"></i></small>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card bg-warning text-dark border-0 shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="stat-icon" style="width: 60px; height: 60px; background: rgba(0, 0, 0, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-cash-coin fs-3"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="stat-number display-6 fw-bold">
                                    ₦<span id="fineAmount">{{ recent_fines_total|default:"0" }}</span>
                                </div>
                                <div class="stat-label">Outstanding Fines</div>
                            </div>
                        </div>
                        <a href="#fines-section" class="stretched-link text-dark text-decoration-none">
                            <small>Pay now <i class="bi bi-arrow-right ms-1"></i></small>
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stat-card bg-info text-white border-0 shadow">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <div class="stat-icon" style="width: 60px; height: 60px; background: rgba(255, 255, 255, 0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="bi bi-star fs-3"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="stat-number display-6 fw-bold">{{ total_read_books }}</div>
                                <div class="stat-label">Books Read</div>
                            </div>
                        </div>
                        <a href="#history-section" class="stretched-link text-white text-decoration-none">
                            <small>View history <i class="bi bi-arrow-right ms-1"></i></small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard Content -->
        <div class="row">
            <!-- Left Column: Loans & Reservations -->
            <div class="col-lg-8">
                <!-- Active Loans Section -->
                <div class="card mb-4 border-0 shadow" id="loans-section">
                    <div class="card-header bg-gradient text-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-book me-2"></i>Active Loans
                        </h5>
                        <span class="badge bg-light text-dark">{{ current_loans|length|default:"0" }} items</span>
                    </div>
                    <div class="card-body p-0">
                        {% if current_loans %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Book Title</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for loan in current_loans %}
                                    <tr class="loan-item {% if loan.is_overdue %}table-danger{% endif %}">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div class="book-cover" style="width: 40px; height: 60px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                                        {% if loan.book.cover_image %}
                                                        <img src="{{ loan.book.cover_image.url }}" alt="{{ loan.book.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                                                        {% else %}
                                                        <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                                                            <i class="bi bi-book text-muted"></i>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">{{ loan.book.title|truncatechars:40 }}</h6>
                                                    <small class="text-muted">{{ loan.book.authors.all.0.name|default:"Unknown Author" }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="due-date">
                                                <strong>{{ loan.due_date|date:"M d, Y" }}</strong>
                                                <div class="small text-muted">{{ loan.due_date|timeuntil }} remaining</div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if loan.is_overdue %}
                                            <span class="badge bg-danger">Overdue</span>
                                            {% else %}
                                            <span class="badge bg-success">On time</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="renewLoan({{ loan.id }})">
                                                    <i class="bi bi-arrow-clockwise"></i> Renew
                                                </button>
                                                <a href="/circulation/loan/{{ loan.id }}/" class="btn btn-outline-secondary">
                                                    <i class="bi bi-info-circle"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-book display-1 text-muted mb-3"></i>
                            <h4 class="text-muted mb-3">No Active Loans</h4>
                            <p class="text-muted mb-4">You don't have any books checked out at the moment.</p>
                            <a href="/catalog/" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Browse Collection
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer bg-light py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                You can renew books up to 2 times if no one else has reserved them.
                            </small>
                            <a href="/circulation/my-loans/" class="btn btn-sm btn-outline-primary">
                                View All Loans <i class="bi bi-arrow-right ms-1"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Reservations Section -->
                <div class="card mb-4 border-0 shadow" id="reservations-section">
                    <div class="card-header bg-gradient text-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>My Reservations
                        </h5>
                        <span class="badge bg-light text-dark">{{ reservations|length|default:"0" }} waiting</span>
                    </div>
                    <div class="card-body p-0">
                        {% if reservations %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Book Title</th>
                                        <th>Position</th>
                                        <th>Status</th>
                                        <th>Estimated Wait</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reservation in reservations %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="me-3">
                                                    <div class="book-cover" style="width: 40px; height: 60px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                                        {% if reservation.book.cover_image %}
                                                        <img src="{{ reservation.book.cover_image.url }}" alt="{{ reservation.book.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                                                        {% else %}
                                                        <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-light">
                                                            <i class="bi bi-book text-muted"></i>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div>
                                                    <h6 class="mb-1">{{ reservation.book.title|truncatechars:40 }}</h6>
                                                    <small class="text-muted">{{ reservation.book.authors.all.0.name|default:"Unknown Author" }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="position-indicator">
                                                <span class="badge bg-primary fs-6">#{{ forloop.counter }}</span>
                                                <div class="small text-muted">in queue</div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if reservation.status == 'ready' %}
                                            <span class="badge bg-success">Ready for pickup</span>
                                            {% else %}
                                            <span class="badge bg-warning">Waiting</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if reservation.estimated_wait %}
                                            <span class="fw-bold">{{ reservation.estimated_wait }} days</span>
                                            {% else %}
                                            <span class="text-muted">Calculating...</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if reservation.status == 'ready' %}
                                                <button class="btn btn-success" onclick="pickupReservation({{ reservation.id }})">
                                                    <i class="bi bi-check-circle me-1"></i> Pickup
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-outline-danger" onclick="cancelReservation({{ reservation.id }})">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-clock display-1 text-muted mb-3"></i>
                            <h4 class="text-muted mb-3">No Reservations</h4>
                            <p class="text-muted mb-4">You haven't reserved any books yet.</p>
                            <a href="/catalog/" class="btn btn-primary">
                                <i class="bi bi-search me-2"></i>Browse Popular Books
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Recent Fines Section -->
                <div class="card border-0 shadow" id="fines-section">
                    <div class="card-header bg-gradient text-white py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-cash-coin me-2"></i>Fines & Payments
                        </h5>
                        <span class="badge bg-light text-dark">Total: ₦<span id="totalFines">{{ recent_fines_total|default:"0" }}</span></span>
                    </div>
                    <div class="card-body">
                        {% if recent_fines %}
                        <div class="mb-4">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Due Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for fine in recent_fines %}
                                        <tr class="{% if fine.status == 'unpaid' %}table-warning{% else %}table-success{% endif %}">
                                            <td>
                                                <div>
                                                    <strong>{{ fine.description|default:"Overdue fine" }}</strong>
                                                    <div class="small text-muted">
                                                        Book: {{ fine.loan.book.title|truncatechars:30 }}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="fw-bold">₦{{ fine.amount }}</td>
                                            <td>{{ fine.due_date|date:"M d, Y" }}</td>
                                            <td>
                                                {% if fine.status == 'paid' %}
                                                <span class="badge bg-success">Paid</span>
                                                {% else %}
                                                <span class="badge bg-danger">Unpaid</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if fine.status == 'unpaid' %}
                                                <button class="btn btn-sm btn-outline-primary" onclick="payFine({{ fine.id }})">
                                                    <i class="bi bi-credit-card me-1"></i> Pay
                                                </button>
                                                {% else %}
                                                <a href="/circulation/receipt/{{ fine.id }}/" class="btn btn-sm btn-outline-secondary">
                                                    <i class="bi bi-receipt"></i> Receipt
                                                </a>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="alert alert-info mb-0">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                                        <div>
                                            <strong>Payment Options:</strong> Pay fines online via credit card, 
                                            mobile money, or in-person at the circulation desk.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-primary btn-lg" onclick="payAllFines()">
                                    <i class="bi bi-credit-card me-2"></i>Pay All Fines
                                </button>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-emoji-smile display-1 text-success mb-3"></i>
                            <h4 class="text-success mb-3">No Outstanding Fines!</h4>
                            <p class="text-muted mb-4">You're all caught up with your payments.</p>
                            <div class="alert alert-success">
                                <i class="bi bi-check-circle-fill me-2"></i>
                                Keep up the good work by returning books on time!
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column: Profile & Quick Actions -->
            <div class="col-lg-4">
                <!-- User Profile Card -->
                <div class="card mb-4 border-0 shadow">
                    <div class="card-header bg-gradient text-white py-3">
                        <h5 class="mb-0">
                            <i class="bi bi-person-circle me-2"></i>My Profile
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <!-- Profile Picture -->
                        <div class="mb-4">
                            <div class="profile-picture mx-auto" style="width: 120px; height: 120px; border-radius: 50%; overflow: hidden; border: 4px solid var(--light-blue);">
                                {% if user.profile_picture %}
                                <img src="{{ user.profile_picture.url }}" alt="{{ user.get_full_name }}" style="width: 100%; height: 100%; object-fit: cover;">
                                {% else %}
                                <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-gradient" style="background: var(--gradient-2);">
                                    <span class="display-4 text-white fw-bold">{{ user.first_name|first|upper }}{{ user.last_name|first|upper }}</span>
                                </div>
                                {% endif %}
                            </div>
                            <div class="mt-3">
                                <h4 class="fw-bold mb-1">{{ user.get_full_name|default:user.username }}</h4>
                                <p class="text-muted mb-2">
                                    <i class="bi bi-person-badge me-1"></i>
                                    {{ user.get_membership_type_display }}
                                </p>
                                {% if user.department %}
                                <p class="text-muted mb-0">
                                    <i class="bi bi-building me-1"></i>
                                    {{ user.department }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Membership Info -->
                        <div class="mb-4">
                            <div class="membership-card p-3 rounded" style="background: var(--light-blue);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Membership ID:</span>
                                    <strong>{{ user.student_id|default:user.faculty_id|default:"N/A" }}</strong>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">Status:</span>
                                    <span class="badge bg-success">Active</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Expires:</span>
                                    <strong>Never</strong>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="d-grid gap-2">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-primary">
                                <i class="bi bi-pencil-square me-2"></i>Edit Profile
                            </a>
                            <a href="/circulation/patron_dashboard/" class="btn btn-outline-success">
                                <i class="bi bi-bell me-2"></i>Notifications ({{ notifications_count }})
                            </a>
                            <a href="/circulation/history/" class="btn btn-outline-info">
                                <i class="bi bi-clock-history me-2"></i>Borrowing History
                            </a>
                            <a href="/catalog/favorites/" class="btn btn-outline-warning">
                                <i class="bi bi-heart me-2"></i>My Favorites
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="card mb-4 border-0 shadow">
                    <div class="card-header bg-light py-3">
                        <h6 class="mb-0">
                            <i class="bi bi-bar-chart me-2"></i>Reading Statistics
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Books This Month</span>
                                <strong>{{ books_this_month }}</strong>
                            </div>
                            <div class="progress progress-md">
                                <div class="progress-bar bg-primary" style="width: {{ books_this_month }}0%;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Reading Goal</span>
                                <strong>{{ reading_goal_progress }}</strong>
                            </div>
                            <div class="progress progress-md">
                                <div class="progress-bar bg-success" style="width: {{ books_this_month }}0%;"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Days Visited</span>
                                <strong>{{ days_visited_this_month }}/{{ days_goal }}</strong>
                            </div>
                                <div class="progress progress-md">
                                <div class="progress-bar bg-info" style="width: 60%;"></div>
                            </div>
                        </div>

                        <div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Renewal Rate</span>
                                <strong>{{ renewal_rate }}%</strong>
                            </div>
                            <div class="progress progress-md">
                                <div class="progress-bar bg-warning" style="width: {{ renewal_rate }}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Links -->
                <div class="card border-0 shadow">
                    <div class="card-header bg-light py-3">
                        <h6 class="mb-0">
                            <i class="bi bi-lightning me-2"></i>Quick Actions
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-6">
                                <a href="/catalog/" class="btn btn-outline-primary w-100 h-100 py-3">
                                    <i class="bi bi-search d-block fs-4 mb-2"></i>
                                    <span>Search Books</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/circulation/room-booking/" class="btn btn-outline-success w-100 h-100 py-3">
                                    <i class="bi bi-calendar d-block fs-4 mb-2"></i>
                                    <span>Book Room</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/repository/" class="btn btn-outline-info w-100 h-100 py-3">
                                    <i class="bi bi-archive d-block fs-4 mb-2"></i>
                                    <span>Repository</span>
                                </a>
                            </div>
                            <div class="col-6">
                                <a href="/events/" class="btn btn-outline-warning w-100 h-100 py-3">
                                    <i class="bi bi-calendar-event d-block fs-4 mb-2"></i>
                                    <span>Events</span>
                                </a>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <div class="alert alert-secondary">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-question-circle fs-4 me-3"></i>
                                    <div class="small">
                                        <strong>Need help?</strong>
                                        <a href="/accounts/contact/" class="text-decoration-none">Contact support</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow">
                    <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-activity me-2"></i>Recent Activity
                        </h5>
                        <a href="/circulation/history/" class="btn btn-sm btn-outline-primary">
                            View Full History
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for activity in recent_activity %}
                            <div class="timeline-item">
                                <div class="timeline-icon {{ activity.icon_bg }}">
                                    <i class="{{ activity.icon }}"></i>
                                </div>
                                <div class="timeline-content">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-1">{{ activity.title }}</h6>
                                        <small class="text-muted">{{ activity.time_ago }}</small>
                                    </div>
                                    <p class="mb-1">{{ activity.description }}</p>
                                </div>
                            </div>
                            {% empty %}
                            <div class="text-center py-4">
                                <i class="bi bi-activity display-1 text-muted mb-3"></i>
                                <h5 class="text-muted">No Recent Activity</h5>
                                <p class="text-muted">Your recent library activities will appear here.</p>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    /* Dashboard Specific Styles */
    .dashboard-page {
        padding-bottom: 4rem;
    }
    
    /* Stat Cards */
    .stat-card {
        transition: all 0.3s ease;
        border-radius: 12px;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2) !important;
    }
    
    .stat-icon {
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover .stat-icon {
        transform: scale(1.1) rotate(5deg);
    }
    
    /* Book Cover */
    .book-cover {
        transition: transform 0.3s ease;
    }
    
    .loan-item:hover .book-cover {
        transform: scale(1.05);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Timeline */
    .timeline {
        position: relative;
        padding-left: 40px;
    }
    
    .timeline::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: var(--light-blue);
    }
    
    .timeline-item {
        position: relative;
        margin-bottom: 20px;
    }
    
    .timeline-icon {
        position: absolute;
        left: -40px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        border: 3px solid white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .timeline-content {
        background: var(--gray-bg);
        padding: 15px;
        border-radius: 8px;
        border-left: 3px solid var(--accent-blue);
    }
    
    /* Membership Card */
    .membership-card {
        transition: all 0.3s ease;
    }
    
    .membership-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Profile Picture */
    .profile-picture {
        transition: all 0.3s ease;
    }
    
    .profile-picture:hover {
        transform: scale(1.05);
        border-color: var(--accent-blue);
    }
    
    /* Quick Action Buttons */
    .btn-outline-primary, .btn-outline-success, 
    .btn-outline-info, .btn-outline-warning {
        transition: all 0.3s ease;
    }
    
    .btn-outline-primary:hover {
        background: var(--primary-blue);
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-success:hover {
        background: #198754;
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-info:hover {
        background: #0dcaf0;
        color: white;
        transform: translateY(-2px);
    }
    
    .btn-outline-warning:hover {
        background: #ffc107;
        color: black;
        transform: translateY(-2px);
    }
    
    /* Table Styling */
    .table-hover tbody tr:hover {
        background-color: rgba(10, 36, 114, 0.05);
    }
    
    /* Progress Bars */
    .progress {
        border-radius: 10px;
        overflow: hidden;
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .stat-card .display-6 {
            font-size: 2rem;
        }
        
        .timeline {
            padding-left: 30px;
        }
        
        .timeline::before {
            left: 15px;
        }
        
        .timeline-icon {
            width: 30px;
            height: 30px;
            left: -30px;
            font-size: 0.8rem;
        }
        
        .table-responsive {
            font-size: 0.9rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Animate stat numbers
        const statNumbers = document.querySelectorAll('.stat-number');
        statNumbers.forEach(stat => {
            const originalText = stat.textContent;
            if (originalText && !isNaN(parseInt(originalText.replace(/[^0-9]/g, '')))) {
                const number = parseInt(originalText.replace(/[^0-9]/g, ''));
                animateCounter(stat, 0, number, 1500);
            }
        });
        
        // Animate fine amount
        const fineAmount = document.getElementById('fineAmount');
        if (fineAmount && fineAmount.textContent) {
            const amount = parseInt(fineAmount.textContent.replace(/[^0-9]/g, ''));
            if (!isNaN(amount)) {
                animateCounter(fineAmount, 0, amount, 2000);
            }
        }
        
        // Counter animation function
        function animateCounter(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const current = Math.floor(progress * (end - start) + start);
                element.textContent = current.toLocaleString();
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }
        
        // Loan renewal function
        window.renewLoan = function(loanId) {
            if (confirm('Are you sure you want to renew this loan?')) {
                // Show loading state
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Renewing...';
                button.disabled = true;
                
                // Simulate API call
                setTimeout(() => {
                    // In real implementation, this would be an AJAX call to renew the loan
                    showToast('success', 'Loan renewed successfully! New due date: Dec 20, 2024');
                    
                    // Update UI
                    const row = button.closest('.loan-item');
                    row.querySelector('.due-date strong').textContent = 'Dec 20, 2024';
                    row.querySelector('.due-date .small').textContent = '14 days remaining';
                    row.querySelector('.badge').className = 'badge bg-success';
                    row.querySelector('.badge').textContent = 'On time';
                    
                    // Reset button
                    button.innerHTML = originalText;
                    button.disabled = false;
                    button.classList.remove('btn-outline-primary');
                    button.classList.add('btn-success');
                    button.innerHTML = '<i class="bi bi-check-circle me-1"></i> Renewed';
                    button.disabled = true;
                    
                    // Update stats
                    updateDashboardStats();
                }, 1000);
            }
        };
        
        // Reservation pickup function
        window.pickupReservation = function(reservationId) {
            if (confirm('Confirm pickup of this reservation?')) {
                const button = event.target.closest('button');
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                button.disabled = true;
                
                setTimeout(() => {
                    showToast('success', 'Reservation marked as picked up!');
                    const row = button.closest('tr');
                    row.remove();
                    updateDashboardStats();
                }, 800);
            }
        };
        
        // Cancel reservation function
        window.cancelReservation = function(reservationId) {
            if (confirm('Are you sure you want to cancel this reservation?')) {
                const button = event.target.closest('button');
                button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cancelling...';
                button.disabled = true;
                
                setTimeout(() => {
                    showToast('info', 'Reservation cancelled successfully.');
                    const row = button.closest('tr');
                    row.remove();
                    updateDashboardStats();
                }, 800);
            }
        };
        
        // Pay fine function
        window.payFine = function(fineId) {
            if (confirm('Proceed to payment for this fine?')) {
                // In real implementation, this would redirect to payment page
                window.location.href = `/circulation/pay-fine/${fineId}/`;
            }
        };
        
        // Pay all fines function
        window.payAllFines = function() {
            const totalFines = document.getElementById('totalFines');
            const amount = totalFines ? parseInt(totalFines.textContent) : 0;
            
            if (amount === 0) {
                showToast('info', 'You have no fines to pay.');
                return;
            }
            
            if (confirm(`Pay all outstanding fines (₦${amount.toLocaleString()})?`)) {
                // In real implementation, this would redirect to payment page
                window.location.href = `/circulation/pay-all-fines/`;
            }
        };
        
        // Update dashboard stats
        function updateDashboardStats() {
            // Update active loans count
            const activeLoans = document.querySelectorAll('.loan-item').length;
            const loansStat = document.querySelector('.stat-card.bg-primary .stat-number');
            if (loansStat) {
                animateCounter(loansStat, parseInt(loansStat.textContent), activeLoans, 500);
            }
            
            // Update reservations count
            const reservationsCount = document.querySelectorAll('#reservations-section tbody tr').length;
            const reservationsStat = document.querySelector('.stat-card.bg-success .stat-number');
            if (reservationsStat) {
                animateCounter(reservationsStat, parseInt(reservationsStat.textContent), reservationsCount, 500);
            }
            
            // Update fines count (simulated)
            const finesRows = document.querySelectorAll('#fines-section tbody tr');
            let unpaidCount = 0;
            let totalAmount = 0;
            
            finesRows.forEach(row => {
                if (row.querySelector('.badge.bg-danger')) {
                    unpaidCount++;
                    const amountCell = row.querySelector('td:nth-child(2)');
                    if (amountCell) {
                        const amount = parseInt(amountCell.textContent.replace(/[^0-9]/g, ''));
                        if (!isNaN(amount)) {
                            totalAmount += amount;
                        }
                    }
                }
            });
            
            const finesBadge = document.querySelector('#fines-section .badge');
            if (finesBadge) {
                finesBadge.innerHTML = `Total: ₦<span id="totalFines">${totalAmount.toLocaleString()}</span>`;
            }
            
            const fineAmountSpan = document.getElementById('fineAmount');
            if (fineAmountSpan) {
                animateCounter(fineAmountSpan, parseInt(fineAmountSpan.textContent.replace(/[^0-9]/g, '')), totalAmount, 500);
            }
        }
        
        // Toast notification function
        function showToast(type, message) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.custom-toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create toast
            const toast = document.createElement('div');
            toast.className = `custom-toast alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'}-fill fs-4 me-3"></i>
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 3000);
        }
        
        // Initialize tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Add hover effects to timeline items
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach(item => {
            item.addEventListener('mouseenter', function() {
                this.querySelector('.timeline-content').style.transform = 'translateX(5px)';
                this.querySelector('.timeline-icon').style.transform = 'scale(1.1)';
            });
            
            item.addEventListener('mouseleave', function() {
                this.querySelector('.timeline-content').style.transform = 'translateX(0)';
                this.querySelector('.timeline-icon').style.transform = 'scale(1)';
            });
        });
        
        // Auto-refresh dashboard every 30 seconds (simulated)
        setInterval(() => {
            // In real implementation, this would fetch updated data
            console.log('Dashboard auto-refresh at:', new Date().toLocaleTimeString());
        }, 30000);
        
        // Print dashboard
        const printButton = document.createElement('button');
        printButton.className = 'btn btn-outline-secondary btn-sm position-fixed d-none d-md-block';
        printButton.innerHTML = '<i class="bi bi-printer"></i>';
        printButton.style.cssText = 'bottom: 20px; right: 20px; z-index: 100;';
        printButton.onclick = () => window.print();
        document.body.appendChild(printButton);
    });
</script>
{% endblock %}
