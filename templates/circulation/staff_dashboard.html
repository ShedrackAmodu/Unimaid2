{% extends 'base.html' %}
{% load static %}

{% block title %}Staff Dashboard - Ramat Library{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/circulation/staff-dashboard/">Circulation</a></li>
<li class="breadcrumb-item active" aria-current="page">Staff Dashboard</li>
{% endblock %}

{% block page_header %}
<div class="row mb-5 animate__animated animate__fadeInUp">
    <div class="col">
        <div class="d-flex align-items-center mb-3">
            <div class="me-3">
                <div class="icon-60 icon-60--gradient">
                    <i class="bi bi-clipboard-data fs-3 text-white"></i>
                </div>
            </div>
            <div>
                <h1 class="display-4 fw-bold mb-2">Staff Dashboard</h1>
                <p class="lead text-muted">Register attendance and access granted documents</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Quick Action Cards - Staff Restricted Access -->
<div class="row g-4 mb-5">
    <div class="col-md-6">
        <div class="card action-card border-0 shadow-hover h-100">
            <div class="card-body text-center p-4">
                <div class="action-icon mb-3">
                    <i class="bi bi-door-open fs-1 text-primary"></i>
                </div>
                <h5 class="fw-bold mb-3">Library Attendance</h5>
                <p class="text-muted mb-4">Register student/library entry and exit</p>
                <a href="{% url 'circulation:register_attendance' %}" class="btn btn-primary w-100">
                    <i class="bi bi-person-plus me-2"></i>Register Entry
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card action-card border-0 shadow-hover h-100">
            <div class="card-body text-center p-4">
                <div class="action-icon mb-3">
                    <i class="bi bi-file-earmark-text fs-1 text-success"></i>
                </div>
                <h5 class="fw-bold mb-3">Document Repository</h5>
                <p class="text-muted mb-4">Access and view granted documents</p>
                <a href="{% url 'repository:document_list' %}" class="btn btn-success w-100 mb-2">
                    <i class="bi bi-file-earmark-text me-2"></i>View Documents
                </a>
                <a href="{% url 'repository:my_requests' %}" class="btn btn-outline-success w-100">
                    <i class="bi bi-clipboard-check me-2"></i>My Requests
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Stats -->
<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="card stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-door-open text-info fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ active_attendances.count }}</h3>
                        <p class="text-muted mb-0">Active Visitors</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-calendar-check text-primary fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <h3 class="fw-bold mb-0">{{ today_attendances.count }}</h3>
                        <p class="text-muted mb-0">Today's Visitors</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card stat-card border-0">
            <div class="card-body p-4">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-purple bg-opacity-10 rounded-circle p-3">
                            <i class="bi bi-file-earmark-spreadsheet text-purple fs-4"></i>
                        </div>
                    </div>
                    <div>
                        <a href="{% url 'circulation:attendance_list' %}" class="text-decoration-none">
                            <h6 class="fw-bold mb-0">View Reports</h6>
                            <p class="text-muted mb-0 small">Attendance records</p>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Reports Section -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card border-0 shadow">
            <div class="card-header bg-white border-0 py-4">
                <h4 class="fw-bold mb-0">
                    <i class="bi bi-file-earmark-spreadsheet me-2 text-primary"></i>Attendance Reports
                </h4>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-4">
                            <div class="me-3">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                                    <i class="bi bi-calendar-check text-primary fs-3"></i>
                                </div>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">Daily Reports</h5>
                                <p class="text-muted mb-0">View today's attendance records</p>
                            </div>
                        </div>
                        <a href="{% url 'circulation:attendance_list' %}?date_filter=today" class="btn btn-primary">
                            <i class="bi bi-eye me-2"></i>View Today's Attendance
                        </a>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center mb-4">
                            <div class="me-3">
                                <div class="bg-success bg-opacity-10 rounded-circle p-3">
                                    <i class="bi bi-file-earmark-excel text-success fs-3"></i>
                                </div>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">Export Data</h5>
                                <p class="text-muted mb-0">Download attendance reports</p>
                            </div>
                        </div>
                        <a href="{% url 'circulation:export_attendance_excel' %}?date_filter=today" class="btn btn-success">
                            <i class="bi bi-download me-2"></i>Export to Excel
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<style>
    .action-card {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 16px;
        overflow: hidden;
    }
    
    .action-card:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0, 31, 63, 0.15) !important;
    }
    
    .action-card .action-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, rgba(var(--primary-rgb), 0.1), rgba(var(--accent-rgb), 0.1));
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    
    .action-card:hover .action-icon {
        transform: scale(1.1) rotate(5deg);
    }
    
    .stat-card {
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        border-color: var(--accent-blue);
        box-shadow: 0 10px 20px rgba(58, 134, 255, 0.15);
    }
    
    .nav-tabs-bordered .nav-link {
        border: none;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: var(--dark-text);
        position: relative;
        border-radius: 0;
        display: flex;
        align-items: center;
    }
    
    .nav-tabs-bordered .nav-link.active {
        color: var(--primary-blue);
        border-bottom: 3px solid var(--primary-blue);
        background: transparent;
    }
    
    .nav-tabs-bordered .nav-link .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    .table-hover tbody tr {
        transition: all 0.2s ease;
    }
    
    .table-hover tbody tr:hover {
        transform: translateX(5px);
        background-color: rgba(var(--primary-rgb), 0.03);
    }
    
    .table-hover .table-danger:hover {
        background-color: rgba(var(--danger-rgb), 0.05) !important;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add current date/time to header
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        
        // Update page subtitle with current date
        const subtitle = document.querySelector('.lead.text-muted');
        if (subtitle) {
            subtitle.textContent += ' | ' + dateStr;
        }
        
        // Initialize tab functionality
        const triggerTabList = document.querySelectorAll('#dashboardTabs button');
        triggerTabList.forEach(triggerEl => {
            const tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener('click', event => {
                event.preventDefault();
                tabTrigger.show();
            });
        });
        
        // Patron search functionality
        const searchInput = document.getElementById('patronSearch');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');
        
        let searchTimeout;
        
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(performSearch, 500);
        });
        
        searchBtn.addEventListener('click', performSearch);
        
        function performSearch() {
            const query = searchInput.value.trim();
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            // Simulate AJAX search
            // In a real implementation, this would be an API call
            searchResults.innerHTML = `
                <div class="list-group">
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">John Doe</h6>
                            <small class="text-muted">Student</small>
                        </div>
                        <p class="mb-1">johndoe@student.unimaid.edu.ng</p>
                        <small class="text-muted">3 active loans, 0 fines</small>
                    </a>
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Jane Smith</h6>
                            <small class="text-muted">Faculty</small>
                        </div>
                        <p class="mb-1">jsmith@unimaid.edu.ng</p>
                        <small class="text-muted">5 active loans, ₦500 in fines</small>
                    </a>
                </div>
            `;
            searchResults.style.display = 'block';
        }
        
        // Fulfill reservation function
        window.fulfillReservation = function(reservationId) {
            const copySelect = document.getElementById(`copySelect${reservationId}`);
            const selectedCopy = copySelect.value;
            
            if (!selectedCopy) {
                alert('Please select a book copy');
                return;
            }
            
            // In real implementation, this would be an AJAX call
            console.log(`Fulfilling reservation ${reservationId} with copy ${selectedCopy}`);
            alert(`Reservation fulfilled! Checkout book copy #${selectedCopy} to the patron.`);
            bootstrap.Modal.getInstance(document.getElementById(`fulfillModal${reservationId}`)).hide();
            
            // Reload page or update table
            setTimeout(() => {
                location.reload();
            }, 1000);
        };
        
        // Apply fine function
        window.applyFine = function(loanId) {
            const amount = document.getElementById(`fineAmount${loanId}`).value;
            const reason = document.getElementById(`fineReason${loanId}`).value;

            if (!amount || amount <= 0) {
                alert('Please enter a valid fine amount');
                return;
            }

            // In real implementation, this would be an AJAX call
            console.log(`Applying fine of ₦${amount} for loan ${loanId}: ${reason}`);
            alert(`Fine of ₦${amount} applied successfully!`);
            bootstrap.Modal.getInstance(document.getElementById(`fineModal${loanId}`)).hide();

            // Reload page or update table
            setTimeout(() => {
                location.reload();
            }, 1000);
        };

        // Reject borrow request function
        window.rejectRequest = function(requestId) {
            const reason = document.getElementById(`rejectReason${requestId}`).value.trim();

            if (!reason) {
                alert('Please provide a reason for rejection');
                return;
            }

            // In real implementation, this would be an AJAX call
            console.log(`Rejecting borrow request ${requestId}: ${reason}`);
            alert('Borrow request rejected successfully!');
            bootstrap.Modal.getInstance(document.getElementById(`rejectModal${requestId}`)).hide();

            // Reload page or update table
            setTimeout(() => {
                location.reload();
            }, 1000);
        };
        
        // Auto-refresh data every 30 seconds
        let refreshInterval = setInterval(() => {
            // In real implementation, this would fetch fresh data via AJAX
            console.log('Auto-refreshing dashboard data...');
            
            // Show refresh indicator
            const refreshIndicator = document.createElement('div');
            refreshIndicator.className = 'position-fixed top-0 end-0 m-3';
            refreshIndicator.innerHTML = `
                <div class="toast bg-success text-white" role="alert">
                    <div class="toast-body">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Updating dashboard data...
                    </div>
                </div>
            `;
            document.body.appendChild(refreshIndicator);
            
            const toast = new bootstrap.Toast(refreshIndicator.querySelector('.toast'));
            toast.show();
            
            setTimeout(() => {
                refreshIndicator.remove();
            }, 2000);
        }, 30000);
        
        // Clean up interval on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(refreshInterval);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl + 1-4 for tab switching
            if (e.ctrlKey && e.key >= '1' && e.key <= '4') {
                e.preventDefault();
                const tabIndex = parseInt(e.key) - 1;
                const tabButtons = document.querySelectorAll('#dashboardTabs button');
                if (tabButtons[tabIndex]) {
                    tabButtons[tabIndex].click();
                }
            }
            
            // Ctrl + F for search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
            
            // Escape to clear search
            if (e.key === 'Escape') {
                searchInput.value = '';
                searchResults.style.display = 'none';
            }
        });
        
        // Print functionality for current tab
        const printButton = document.createElement('button');
        printButton.className = 'btn btn-outline-primary position-fixed d-none d-md-block';
        printButton.innerHTML = '<i class="bi bi-printer"></i>';
        printButton.style.bottom = '6rem';
        printButton.style.left = '2rem';
        printButton.style.zIndex = '100';
        printButton.onclick = function() {
            const activeTab = document.querySelector('#dashboardTabsContent .tab-pane.active');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Ramat Library - Staff Dashboard Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .badge { padding: 2px 6px; border-radius: 4px; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h2>Ramat Library - Staff Dashboard Report</h2>
                    <p>Generated on ${new Date().toLocaleString()}</p>
                    ${activeTab.outerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        };
        document.body.appendChild(printButton);
    });
</script>
{% endblock %}
